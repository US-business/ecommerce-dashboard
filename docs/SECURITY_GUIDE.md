# دليل الأمان - نظام المصادقة والحساب

## 🔒 **تقييم الأمان الحالي**

### ✅ **النقاط الإيجابية:**
- تشفير كلمات المرور باستخدام bcrypt (10 rounds)
- استخدام JWT tokens آمنة
- فصل الأدوار (super_admin / viewer)
- حماية API routes
- استخدام HTTPS في الإنتاج (مطلوب)
- دعم OAuth مع Google

### ⚠️ **نقاط تحتاج تحسين:**

## 🛡️ **التوصيات الأمنية**

### 1. **متغيرات البيئة**
```bash
# استخدم مولد أسرار قوي
NEXTAUTH_SECRET=$(openssl rand -base64 32)
JWT_SECRET=$(openssl rand -hex 64)

# لا تستخدم أبداً في الإنتاج
SUPER_ADMIN_PASSWORD="123"  # ❌ ضعيف جداً
```

### 2. **كلمات المرور**
- الحد الأدنى: 8 أحرف
- يجب أن تحتوي على: أحرف كبيرة، صغيرة، أرقام، رموز
- تشفير bcrypt مع 12 rounds للإنتاج

### 3. **الجلسات**
- مدة انتهاء: 30 يوم (قابل للتخصيص)
- تدوير tokens تلقائياً
- إلغاء الجلسات عند تغيير كلمة المرور

### 4. **حماية API**
```typescript
// فحص الصلاحيات في كل API route
const session = await getServerSession(authOptions)
if (!session?.user) {
  return NextResponse.json({ error: "Unauthorized" }, { status: 401 })
}

if (session.user.role !== "super_admin") {
  return NextResponse.json({ error: "Forbidden" }, { status: 403 })
}
```

### 5. **حماية قاعدة البيانات**
- استخدام SSL connections
- تشفير البيانات الحساسة
- نسخ احتياطية منتظمة
- مراقبة الوصول

## 🚨 **مخاطر أمنية محتملة**

### 1. **تسريب متغيرات البيئة**
```bash
# ❌ خطر: بيانات حقيقية في .env.local
GOOGLE_CLIENT_SECRET="GOCSPX-real-secret-here"

# ✅ آمن: استخدام متغيرات الإنتاج
GOOGLE_CLIENT_SECRET="${GOOGLE_CLIENT_SECRET}"
```

### 2. **هجمات Brute Force**
- تطبيق rate limiting
- قفل الحساب بعد محاولات فاشلة
- تسجيل محاولات الدخول المشبوهة

### 3. **Session Hijacking**
- استخدام secure cookies
- تجديد session tokens
- فحص IP addresses

## 🔧 **خطوات التأمين للإنتاج**

### 1. **تحديث متغيرات البيئة**
```bash
# إنشاء أسرار قوية
npm run generate-secrets

# تحديث Google OAuth URLs
NEXTAUTH_URL="https://yourdomain.com"
```

### 2. **تفعيل HTTPS**
```javascript
// next.config.mjs
const nextConfig = {
  async headers() {
    return [
      {
        source: '/(.*)',
        headers: [
          {
            key: 'Strict-Transport-Security',
            value: 'max-age=31536000; includeSubDomains'
          }
        ]
      }
    ]
  }
}
```

### 3. **مراقبة الأمان**
- تسجيل جميع عمليات تسجيل الدخول
- تنبيهات للأنشطة المشبوهة
- مراجعة دورية للصلاحيات

### 4. **نسخ احتياطية**
- نسخ يومية لقاعدة البيانات
- تشفير النسخ الاحتياطية
- اختبار استعادة البيانات

## 📋 **قائمة فحص الأمان**

### قبل الإنتاج:
- [ ] تغيير جميع كلمات المرور الافتراضية
- [ ] تفعيل HTTPS
- [ ] تحديث Google OAuth URLs
- [ ] إنشاء أسرار قوية
- [ ] تفعيل rate limiting
- [ ] إعداد مراقبة الأمان
- [ ] اختبار النسخ الاحتياطية
- [ ] مراجعة صلاحيات المستخدمين

### مراقبة مستمرة:
- [ ] مراجعة logs الأمان أسبوعياً
- [ ] تحديث dependencies شهرياً
- [ ] اختبار اختراق ربع سنوي
- [ ] مراجعة صلاحيات المستخدمين شهرياً

## 🆘 **خطة الاستجابة للحوادث**

### في حالة اختراق محتمل:
1. **فوري**: قطع الاتصال بقاعدة البيانات
2. **خلال 5 دقائق**: تغيير جميع كلمات المرور
3. **خلال 15 دقيقة**: إلغاء جميع الجلسات النشطة
4. **خلال ساعة**: تحليل logs وتحديد نطاق الضرر
5. **خلال 24 ساعة**: إصلاح الثغرة وإعادة التشغيل

## 📞 **جهات الاتصال**
- **مطور النظام**: [البريد الإلكتروني]
- **مدير قاعدة البيانات**: [البريد الإلكتروني]
- **فريق الأمان**: [البريد الإلكتروني]

---

**تذكر**: الأمان عملية مستمرة وليس حدث لمرة واحدة!